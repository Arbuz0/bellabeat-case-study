---
title: 'Bellabeat Case Study'
author: '≈Åukasz Janiak'
output: 
  html_document:
    code_folding: show
date: 'in progress'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Sys.setlocale("LC_TIME", "Polish_Poland.1250")
Sys.setlocale("LC_TIME", "C")
```

## Business Task

Questions for analysis:

* What are some trends in smart device usage?
* How could these trends apply to Bellabeat customers?
* How could these trends help influence Bellabeat marketing strategy?

## Data source

Data was downloaded from [Fitbit Fitness Tracker Data](https://www.kaggle.com/datasets/arashnic/fitbit) 
from the Kaggle web repository.  
License: CC0: Public Domain  

This dataset generated by respondents to a distributed survey via Amazon Mechanical Turk between 12.03.2016-12.05.2016. 
Thirty eligible Fitbit users consented to the submission of personal tracker data, 
including minute-level output for physical activity, heart rate, and sleep monitoring. 
Variation between output represents use of different types of Fitbit trackers and individual tracking behaviors / preferences.

## Data limitations
* small sample
* seasonal data
* no metadata / lack of demographics

## Loading packages

```{r, message = FALSE}
library("readr")
library("ggplot2")
library("dplyr")
library("lubridate")
library("tidyr")
library("janitor")
library("stringr")
```

## Importing datasets

```{r, message = FALSE}
daily_activity <- read_csv("Fitabase_Data_4.12.16-5.12.16/dailyActivity_merged.csv") # nolint
hourly_calories <- read_csv("Fitabase_Data_4.12.16-5.12.16/hourlyCalories_merged.csv" ) # nolint
hourly_intensities <- read_csv("Fitabase_Data_4.12.16-5.12.16/hourlyIntensities_merged.csv") # nolint
hourly_steps <- read_csv("Fitabase_Data_4.12.16-5.12.16/hourlySteps_merged.csv")
sleep_day <- read_csv("Fitabase_Data_4.12.16-5.12.16/sleepDay_merged.csv")
heart_rate <- read_csv("Fitabase_Data_4.12.16-5.12.16/heartrate_seconds_merged.csv") # nolint
weight_log <- read_csv("Fitabase_Data_4.12.16-5.12.16/weightLogInfo_merged.csv")
```

## Data Preview {.tabset}

### Daily Activity

```{r}
head(daily_activity)
str(daily_activity)
```

### Hourly Calories

```{r}
head(hourly_calories)
str(hourly_calories)
```

### Hourly Intensities

```{r}
head(hourly_intensities)
str(hourly_intensities)
```

### Hourly Steps

```{r}
head(hourly_steps)
str(hourly_steps)
```

### Sleep Day

```{r}
head(sleep_day)
str(sleep_day)
```

### Heart Rate

```{r}
head(heart_rate)
str(heart_rate)
```

### Weight Log

```{r}
head(weight_log)
str(weight_log)
```

## {-}

## Data cleaning {.tabset}

### Daily Activity

```{r, warning = FALSE}
sum(duplicated(daily_activity))

daily_activity <- daily_activity %>%
  clean_names() %>%
  mutate(activity_date = mdy(activity_date), day_of_week = weekdays(activity_date)) %>% # nolint
  rename("date" = activity_date)

head(daily_activity)
```

### Hourly Calories

```{r, warning = FALSE}
sum(duplicated(hourly_calories))

hourly_calories <- hourly_calories %>%
  clean_names() %>%
  separate(col = activity_hour, into = c("date", "time"), sep = " ") %>%
  mutate(date = mdy(date), day_of_week = weekdays(date))

head(hourly_calories)
```

### Hourly Intensities

```{r, warning = FALSE}
sum(duplicated(hourly_intensities))

hourly_intensities <- hourly_intensities %>%
  clean_names() %>%
  separate(col = activity_hour, into = c("date", "time"), sep = " ") %>%
  mutate(date = mdy(date), day_of_week = weekdays(date))

head(hourly_intensities)
```

### Hourly Steps

```{r, warning = FALSE}
sum(duplicated(hourly_steps))

hourly_steps <- hourly_steps %>%
  clean_names() %>%
  separate(col = activity_hour, into = c("date", "time"), sep = " ") %>%
  mutate(date = mdy(date), day_of_week = weekdays(date))

head(hourly_steps)
```

### Sleep Day

```{r, warning = FALSE}
sum(duplicated(sleep_day))
sleep_day <- distinct(sleep_day)
sum(duplicated(sleep_day))

sleep_day <- sleep_day %>%
  clean_names() %>%
  separate(col = sleep_day, into = c("date", "time"), sep = " ") %>%
  mutate(date = mdy(date), day_of_week = weekdays(date))

head(sleep_day)
```

### Heart Rate

```{r, warning = FALSE}
sum(duplicated(heart_rate))

heart_rate <- heart_rate %>%
  clean_names() %>%
  separate(col = time, into = c("date", "time"), sep = " ") %>%
  mutate(date = mdy(date), day_of_week = weekdays(date))

head(heart_rate)
```

### Weight Log

```{r, warning = FALSE}
sum(duplicated(weight_log))

weight_log <- weight_log %>%
  clean_names() %>%
  mutate(date = date(mdy_hms(date)), day_of_week = weekdays(date)) %>%
  rename("date" = date)

head(weight_log)
str(weight_log)
```

## {-}

## Data validation

Table **'daily_activity'** contains records from **`r min(daily_activity$date)`** 
to **`r max(daily_activity$date)`** and contains **`r n_distinct(daily_activity$id)`** users.  
Table **'hourly_calories'** contains records from **`r min(hourly_calories$date)`** 
to **`r max(hourly_calories$date)`** and contains **`r n_distinct(hourly_calories$id)`** users.  
Table **'hourly_intensities'** contains records from **`r min(hourly_intensities$date)`** 
to **`r max(hourly_intensities$date)`** and contains **`r n_distinct(hourly_intensities$id)`** users.  
Table **'hourly_steps'** contains records from **`r min(hourly_steps$date)`** 
to **`r max(hourly_steps$date)`** and contains **`r n_distinct(hourly_steps$id)`** users.  
Table **'sleep_day'** contains records from **`r min(sleep_day$date)`** 
to **`r max(sleep_day$date)`** and contains **`r n_distinct(sleep_day$id)`** users.  
Table **'heart_rate'** contains records from **`r min(heart_rate$date)`** 
to **`r max(heart_rate$date)`** and contains **`r n_distinct(heart_rate$id)`** users.  
Table **'weight_log'** contains records from **`r min(weight_log$date)`** 
to **`r max(weight_log$date)`** and contains **`r n_distinct(weight_log$id)`** users.  

For further analysis I am going to leave out **'weight_log'** and **'heart_rate'** 
because of insufficient number of unique users.

```{r}
daily_activity %>%
  select(total_steps, total_distance, calories) %>%
  summary()

daily_activity %>%
  select(very_active_minutes, fairly_active_minutes, lightly_active_minutes, sedentary_minutes) %>% # nolint
  summary()
```

In **'daily_activity'** table every measure category minimum is 0. 
The most likely cause is missing data due to users not using app. More data is needed to determine it. 
Need to be careful about that in future steps.

## Analysis

Let's make an auxiliary data frame, which will divide users into 3 groups (high active, moderete active, lowly activity).

```{r}
activity_and_sleep <- merge(daily_activity, sleep_day, by = c("id", "date"))

activity <- activity_and_sleep %>%
  group_by(id) %>%
  summarize(active_days = n_distinct(date)) %>%
  mutate(usage = case_when(
    active_days >= 1 & active_days <= 10 ~ "low use",
    active_days >= 11 & active_days <= 20 ~ "moderate use",
    active_days >= 21 & active_days <= 31 ~ "high use"
    )
  )

head(activity)
```


```{r, class.source = 'fold-hide'}
activity %>%
    group_by(usage) %>%
    summarise(total = n_distinct(id)) %>%
    ggplot() +
      geom_col(mapping = aes(x = usage, y = total, fill = usage)) +
      scale_y_continuous(breaks = seq(0, 13, by = 1), limits = c(0, 13))
```


```{r, class.source = 'fold-hide'}
activity_percent <- activity %>%
  group_by(usage) %>%
  summarise(total = n_distinct(id)) %>%
  mutate(totals = sum(total)) %>%
  group_by(usage) %>%
  summarise(total, total_percent = scales::percent(total / totals))

head(activity_percent)
```


```{r, class.source = 'fold-hide', message = FALSE}
daily_activity %>%
  group_by(date) %>%
  summarize("unique_users" = n_distinct(id)) %>%
  ggplot() +
    geom_smooth(mapping = aes(x = date, y = unique_users)) +
    geom_point(mapping = aes(x = date, y = unique_users)) +
    labs(title = "Unique users over time",
      subtitle = "Feature: Daily activity tracker",
      x = "Date",
      y = "Unique users") +
    scale_y_continuous(breaks = seq(0, 36, by = 2), limits = c(0, 36)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


```{r, class.source = 'fold-hide', message = FALSE}
sleep_day %>%
  group_by(date) %>%
  summarize("unique_users" = n_distinct(id)) %>%
  ggplot() +
    geom_smooth(mapping = aes(x = date, y = unique_users)) +
    geom_point(mapping = aes(x = date, y = unique_users)) +
    labs(title = "Unique users over time",
      subtitle = "Feature: Sleep tracker",
      x = "Date",
      y = "Unique users") +
    scale_y_continuous(breaks = seq(0, 20, by = 2), limits = c(0, 20)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r, class.source = 'fold-hide', message = FALSE}
activity_and_sleep %>%
  merge(y = activity, by = "id", all = TRUE) %>%
  group_by(date, usage) %>%
  summarize("unique_users" = n_distinct(id)) %>%
  ggplot() +
    geom_smooth(mapping = aes(x = date, y = unique_users)) +
    geom_point(mapping = aes(x = date, y = unique_users, color = usage)) +
    labs(title = "Unique users over time",
      subtitle = "Feature: Sleep tracker",
      x = "Date",
      y = "Unique users") +
    scale_y_continuous(breaks = seq(0, 20, by = 2), limits = c(0, 20)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    facet_wrap(~usage)
```


```{r, class.source = 'fold-hide', message = FALSE}
daily_steps_avg <- hourly_steps %>%
  group_by(date, id, day_of_week) %>%
  summarise(steps_by_day = sum(step_total)) %>%
  group_by(day_of_week) %>%
  summarise(steps_by_weekday = mean(steps_by_day))

  
daily_steps_avg$day_of_week <- ordered(daily_steps_avg$day_of_week, levels =
c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

daily_steps_avg %>%
  ggplot() +
    geom_col(mapping = aes(x = day_of_week, y = steps_by_weekday, fill = day_of_week)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


```{r, class.source = 'fold-hide'}
daily_calories_avg <- hourly_calories %>%
  group_by(date, id, day_of_week) %>%
  summarise(calories_by_day = sum(calories)) %>%
  group_by(day_of_week) %>%
  summarise(calories_by_weekday = mean(calories_by_day))

  
daily_calories_avg$day_of_week <- ordered(daily_calories_avg$day_of_week, levels =
c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

daily_calories_avg %>%
  ggplot() +
    geom_col(mapping = aes(x = day_of_week, y = calories_by_weekday, fill = day_of_week)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Summary