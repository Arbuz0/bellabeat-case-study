---
title: 'Bellabeat Case Study'
author: '≈Åukasz Janiak'
output: 
  html_document:
    code_folding: show
date: '08-04-2022'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setlocale("LC_TIME", "C")
```

## Business Task

Questions for analysis:

* What are some trends in smart device usage?
* How could these trends apply to Bellabeat customers?

The purpose of this analysis is to find trends in Fitbit tracking device usage and 
use these insights to set Bellabeat development in the right direction.

## Data source

Data was downloaded from [Fitbit Fitness Tracker Data](https://www.kaggle.com/datasets/arashnic/fitbit) 
from the Kaggle web repository.  
License: CC0: Public Domain  

This dataset generated by respondents to a distributed survey via Amazon Mechanical Turk between 12.03.2016-12.05.2016. 
Thirty eligible Fitbit users consented to the submission of personal tracker data, 
including minute-level output for physical activity, heart rate, and sleep monitoring. 
Variation between output represents use of different types of Fitbit trackers and individual tracking behaviors / preferences.


## Data limitations
* Small sample size - only 33 unique users took part in this survey
* "Seasonal" data - data contains only records from **one month period** (may not be representative of the entire year)
* No metadata - the data does not contain any demographic information,
 so it may come from a specific group and not represent the general population

## Loading packages

```{r, message = FALSE}
library("readr")
library("ggplot2")
library("dplyr")
library("lubridate")
library("tidyr")
library("janitor")
library("stringr")
```

## Importing datasets

```{r, message = FALSE}
daily_activity <- read_csv("Fitabase_Data_4.12.16-5.12.16/dailyActivity_merged.csv") # nolint
hourly_calories <- read_csv("Fitabase_Data_4.12.16-5.12.16/hourlyCalories_merged.csv" ) # nolint
hourly_intensities <- read_csv("Fitabase_Data_4.12.16-5.12.16/hourlyIntensities_merged.csv") # nolint
hourly_steps <- read_csv("Fitabase_Data_4.12.16-5.12.16/hourlySteps_merged.csv")
sleep_day <- read_csv("Fitabase_Data_4.12.16-5.12.16/sleepDay_merged.csv")
heart_rate <- read_csv("Fitabase_Data_4.12.16-5.12.16/heartrate_seconds_merged.csv") # nolint
weight_log <- read_csv("Fitabase_Data_4.12.16-5.12.16/weightLogInfo_merged.csv")
```

## Data Preview {.tabset}

### Daily Activity

```{r}
head(daily_activity)
str(daily_activity)
```

### Hourly Calories

```{r}
head(hourly_calories)
str(hourly_calories)
```

### Hourly Intensities

```{r}
head(hourly_intensities)
str(hourly_intensities)
```

### Hourly Steps

```{r}
head(hourly_steps)
str(hourly_steps)
```

### Sleep Day

```{r}
head(sleep_day)
str(sleep_day)
```

### Heart Rate

```{r}
head(heart_rate)
str(heart_rate)
```

### Weight Log

```{r}
head(weight_log)
str(weight_log)
```

## {-}

## Data cleaning {.tabset}

Processes done during this phase:   
* finding and removinge any duplicates  
* splitting timestamps into two separate columns (date and time of day)  
* making column names formatting consistent (snake_case)  

### Daily Activity

```{r, warning = FALSE}
sum(duplicated(daily_activity))

daily_activity <- daily_activity %>%
  clean_names() %>%
  mutate(activity_date = mdy(activity_date), day_of_week = weekdays(activity_date)) %>% # nolint
  rename("date" = activity_date)

head(daily_activity)
```

### Hourly Calories

```{r, warning = FALSE}
sum(duplicated(hourly_calories))

hourly_calories <- hourly_calories %>%
  clean_names() %>%
  separate(col = activity_hour, into = c("date", "time", "indicator"), sep = " ") %>% # nolint
  mutate(time = paste(time, indicator, sep = " ")) %>%
  mutate(date = mdy(date), time = format(strptime(time, "%I:%M:%S %p"), "%H:%M:%S"), day_of_week = weekdays(date)) %>% # nolint
  subset(select = -c(indicator))

head(hourly_calories)
```

### Hourly Intensities

```{r, warning = FALSE}
sum(duplicated(hourly_intensities))

hourly_intensities <- hourly_intensities %>%
  clean_names() %>%
  separate(col = activity_hour, into = c("date", "time", "indicator"), sep = " ") %>% # nolint
  mutate(time = paste(time, indicator, sep = " ")) %>%
  mutate(date = mdy(date), time = format(strptime(time, "%I:%M:%S %p"), "%H:%M:%S"), day_of_week = weekdays(date)) %>% # nolint
  subset(select = -c(indicator))

head(hourly_intensities)
```

### Hourly Steps

```{r, warning = FALSE}
sum(duplicated(hourly_steps))

hourly_steps <- hourly_steps %>%
  clean_names() %>%
  separate(col = activity_hour, into = c("date", "time", "indicator"), sep = " ") %>% # nolint
  mutate(time = paste(time, indicator, sep = " ")) %>%
  mutate(date = mdy(date), time = format(strptime(time, "%I:%M:%S %p"), "%H:%M:%S"), day_of_week = weekdays(date)) %>% # nolint
  subset(select = -c(indicator))

head(hourly_steps)
```

### Sleep Day

```{r, warning = FALSE}
sum(duplicated(sleep_day))
sleep_day <- distinct(sleep_day)
sum(duplicated(sleep_day))

sleep_day <- sleep_day %>%
  clean_names() %>%
  separate(col = sleep_day, into = c("date", "time", "indicator"), sep = " ") %>% # nolint
  mutate(time = paste(time, indicator, sep = " ")) %>%
  mutate(date = mdy(date), time = format(strptime(time, "%I:%M:%S %p"), "%H:%M:%S"), day_of_week = weekdays(date)) %>% # nolint
  subset(select = -c(indicator))

head(sleep_day)
```

### Heart Rate

```{r, warning = FALSE}
sum(duplicated(heart_rate))

heart_rate <- heart_rate %>%
  clean_names() %>%
  separate(col = time, into = c("date", "time", "indicator"), sep = " ") %>%
  mutate(time = paste(time, indicator, sep = " ")) %>%
  mutate(date = mdy(date), time = format(strptime(time, "%I:%M:%S %p"), "%H:%M:%S"),day_of_week = weekdays(date))  # nolint

head(heart_rate)
```

### Weight Log

```{r, warning = FALSE}
sum(duplicated(weight_log))

weight_log <- weight_log %>%
  clean_names() %>%
  mutate(date = date(mdy_hms(date)), day_of_week = weekdays(date)) %>%
  rename("date" = date)

head(weight_log)
str(weight_log)
```

## {-}

## Data validation

Table **'daily_activity'** contains records from **`r min(daily_activity$date)`** 
to **`r max(daily_activity$date)`** and contains **`r n_distinct(daily_activity$id)`** users.  
Table **'hourly_calories'** contains records from **`r min(hourly_calories$date)`** 
to **`r max(hourly_calories$date)`** and contains **`r n_distinct(hourly_calories$id)`** users.  
Table **'hourly_intensities'** contains records from **`r min(hourly_intensities$date)`** 
to **`r max(hourly_intensities$date)`** and contains **`r n_distinct(hourly_intensities$id)`** users.  
Table **'hourly_steps'** contains records from **`r min(hourly_steps$date)`** 
to **`r max(hourly_steps$date)`** and contains **`r n_distinct(hourly_steps$id)`** users.  
Table **'sleep_day'** contains records from **`r min(sleep_day$date)`** 
to **`r max(sleep_day$date)`** and contains **`r n_distinct(sleep_day$id)`** users.  
Table **'heart_rate'** contains records from **`r min(heart_rate$date)`** 
to **`r max(heart_rate$date)`** and contains **`r n_distinct(heart_rate$id)`** users.  
Table **'weight_log'** contains records from **`r min(weight_log$date)`** 
to **`r max(weight_log$date)`** and contains **`r n_distinct(weight_log$id)`** users.  

For further analysis I am going to leave out **'weight_log'** and **'heart_rate'** 
because of insufficient number of unique users.

## Analysis

```{r}
daily_activity %>%
  select(total_steps, total_distance, calories) %>%
  summary()
```

In **'daily_activity'** table every measure category minimum is 0. 
More data is needed to determine the cause or even if data is valid. 
For the further analysis I'm going to assume the data is correct.

Now let's split users into 3 groups (depending on their daily activity).
I will mostly focus on users who used at least once daily activity tracking and sleep tracking features.  

Usage groups:   
* 0 - 10 days of activity -> low use  
* 11 - 20 days of activity -> moderate use  
* 21 - 31 days of activity -> high use

```{r}
activity_and_sleep <- merge(daily_activity, sleep_day, by = c("id", "date"))

activity <- activity_and_sleep %>%
  group_by(id) %>%
  summarize(active_days = n_distinct(date)) %>%
  mutate(usage = case_when(
    active_days >= 1 & active_days <= 10 ~ "low use",
    active_days >= 11 & active_days <= 20 ~ "moderate use",
    active_days >= 21 & active_days <= 31 ~ "high use"
    )
  )

head(activity)
```

```{r, class.source = 'fold-hide'}
activity %>%
    group_by(usage) %>%
    summarise(total = n_distinct(id)) %>%
    ggplot() +
      geom_col(mapping = aes(x = usage, y = total, fill = usage)) +
      scale_y_continuous(breaks = seq(0, 13, by = 1), limits = c(0, 13)) +
      labs(x = "type of usage", y = "number of users",
      title = "Number of users per usage type",
      caption = "Only counted for people using both sleep tracking and daily activity") # nolint
```

```{r, class.source = 'fold-hide'}
activity_percent <- activity %>%
  group_by(usage) %>%
  summarise(total = n_distinct(id)) %>%
  mutate(totals = sum(total)) %>%
  group_by(usage) %>%
  summarise(total, total_percent = scales::percent(total / totals))

head(activity_percent)
```

**Conclusions**:   
* Half of the users used app for atleast 21 days.  
* Moderate users (11 - 20) are only one-tenth of all users.  
* People tends to use app either on daily basis or only once per 3 or more days  
* Around 40% users use app only every 3 or more days   

There is no point in analyzing this 3 groups separately because of to small amount of samples in each one.

```{r, class.source = 'fold-hide', message = FALSE}
daily_activity %>%
  mutate("active_minutes" = very_active_minutes +
    fairly_active_minutes + lightly_active_minutes + sedentary_minutes) %>%
  mutate("active_hours" = round(active_minutes / 60)) %>%
  group_by(active_hours) %>%
  summarise("days" = n()) %>%
  ggplot() +
    geom_col(mapping = aes(x = active_hours, y = days, fill = active_hours)) +
    labs(x = "active hours", y = "number of days",
      title = "Number of days per number of active hours in a day",
      caption = "Considering 33 users") # nolint
```

```{r, class.source = 'fold-hide', message = FALSE}
activity_and_sleep %>%
  mutate("active_minutes" = very_active_minutes +
    fairly_active_minutes + lightly_active_minutes + sedentary_minutes) %>%
  mutate("active_hours" = round(active_minutes / 60)) %>%
  group_by(active_hours) %>%
  summarise("days" = n()) %>%
  ggplot() +
    geom_col(mapping = aes(x = active_hours, y = days, fill = active_hours)) +
    labs(x = "active hours", y = "number of days",
      title = "Number of days per number of active hours in a day",
      caption = "Only counted for people using both sleep tracking and daily activity") # nolint
```

```{r, class.source = 'fold-hide', message = FALSE}
daily_activity %>%
  mutate("active_minutes" = very_active_minutes +
    fairly_active_minutes + lightly_active_minutes + sedentary_minutes) %>%
  mutate("active_hours" = round(active_minutes / 60)) %>%
  group_by(active_hours) %>%
  summarise("days" = n()) %>%
  ggplot() +
    geom_col(mapping = aes(x = active_hours, y = days, fill = active_hours)) +
    scale_x_binned(n.breaks = 3) +
    labs(x = "active hours", y = "number of days",
      title = "Number of days per number of active hours in a day",
      subtitle = "Grouped into 3 categories",
      caption = "Considering all 33 users") # nolint
```

```{r, class.source = 'fold-hide', message = FALSE}
activity_and_sleep %>%
  mutate("active_minutes" = very_active_minutes +
    fairly_active_minutes + lightly_active_minutes + sedentary_minutes) %>%
  mutate("active_hours" = round(active_minutes / 60)) %>%
  group_by(active_hours) %>%
  summarise("days" = n()) %>%
  ggplot() +
    geom_col(mapping = aes(x = active_hours, y = days, fill = active_hours)) +
    scale_x_binned(n.breaks = 3) +
    labs(x = "active hours", y = "number of days",
      title = "Number of days per number of active hours in a day",
      subtitle = "Grouped into 3 categories",
      caption = "Only counted for people using both sleep tracking and daily activity") # nolint
```

**Conclusions**:   
* We can split users into 2 groups: one using device a whole day
and the other using it for about 2/3 of the day (only daily activity).  
* Interestingly, majority of people who use both sleep and daily activity
tracking fall into category 15 - 20 hours per day and only a small group uses
device for an entire day  

```{r, class.source = 'fold-hide', message = FALSE}
daily_activity %>%
  group_by(date) %>%
  summarize("unique_users" = n_distinct(id)) %>%
  ggplot() +
    geom_smooth(mapping = aes(x = date, y = unique_users)) +
    geom_point(mapping = aes(x = date, y = unique_users)) +
    labs(title = "Unique users over time",
      subtitle = "Feature: Daily activity tracker",
      x = "Date",
      y = "Unique users") +
    scale_y_continuous(breaks = seq(0, 36, by = 2), limits = c(0, 36)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r, class.source = 'fold-hide', message = FALSE}
sleep_day %>%
  group_by(date) %>%
  summarize("unique_users" = n_distinct(id)) %>%
  ggplot() +
    geom_smooth(mapping = aes(x = date, y = unique_users)) +
    geom_point(mapping = aes(x = date, y = unique_users)) +
    labs(title = "Unique users over time",
      subtitle = "Feature: Sleep tracker",
      x = "Date",
      y = "Unique users") +
    scale_y_continuous(breaks = seq(0, 20, by = 2), limits = c(0, 20)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

**Conclusions**:   
* After around 2 weeks user base starts to decrease (both features)  
* The rate of decline is only increasing  

```{r, class.source = 'fold-hide', message = FALSE}
daily_steps_avg <- hourly_steps %>%
  group_by(date, id, day_of_week) %>%
  summarise(steps_by_day = sum(step_total)) %>%
  group_by(day_of_week) %>%
  summarise(steps_by_weekday = mean(steps_by_day))

  
daily_steps_avg$day_of_week <- ordered(daily_steps_avg$day_of_week, levels =
c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

daily_steps_avg %>%
  ggplot() +
    geom_col(mapping = aes(x = day_of_week, y = steps_by_weekday, fill = day_of_week)) + # nolint
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    labs(x = "day of the week", y = "steps",
      title = "Average steps taken per week of the day",
      caption = "Considering all 33 users")
```

```{r, class.source = 'fold-hide', message = FALSE}
hourly_steps %>%
  group_by(time) %>%
  summarise(average_steps = mean(step_total)) %>%
  ggplot() +
    geom_point(mapping = aes(x = time, y = average_steps)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    scale_y_continuous(breaks = seq(0, 900, by = 100), limits = c(0, 900)) +
    labs(x = "hour of the day", y = "steps",
      title = "Average steps taken per hour of the day",
      caption = "Considering all 33 users")
```

**Conclusions**:   
* On average people walk slightly less in the middle of the week  
* Visible minimum is on Sunday  
* Most of the steps are taken from 8:00 to 19:00  

```{r, class.source = 'fold-hide', message = FALSE}
daily_calories_avg <- hourly_calories %>%
  group_by(date, id, day_of_week) %>%
  summarise(calories_by_day = sum(calories)) %>%
  group_by(day_of_week) %>%
  summarise(calories_by_weekday = mean(calories_by_day))

  
daily_calories_avg$day_of_week <- ordered(daily_calories_avg$day_of_week, levels = # nolint
c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

daily_calories_avg %>%
  ggplot() +
    geom_col(mapping = aes(x = day_of_week, y = calories_by_weekday, fill = day_of_week)) + # nolint
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    labs(x = "day of the week", y = "calories",
      title = "Average calories eaten per week of the day",
      caption = "Considering all 33 users")
```

```{r, class.source = 'fold-hide', message = FALSE}
hourly_calories %>%
  group_by(time) %>%
  summarise(average_calories = mean(calories)) %>%
  ggplot() +
    geom_point(mapping = aes(x = time, y = average_calories)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    scale_y_continuous(breaks = seq(0, 150, by = 20), limits = c(0, 150)) +
    labs(x = "hour of the day", y = "calories",
      title = "Average calories eaten per hour of the day",
      caption = "Considering all 33 users")
```

**Conclusions**:   
* On average people eat slightly less during Thursdays and Sundays  
* Average calories intake during night hours is surprisingly high  

```{r, class.source = 'fold-hide', message = FALSE}
daily_intensity_avg <- hourly_intensities %>%
  group_by(date, id, day_of_week) %>%
  summarise(intensity_by_day = sum(total_intensity) / 24) %>%
  group_by(day_of_week) %>%
  summarise(intensity_by_weekday = mean(intensity_by_day))

  
daily_intensity_avg$day_of_week <- ordered(daily_intensity_avg$day_of_week, levels = # nolint
c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

daily_intensity_avg %>%
  ggplot() +
    geom_col(mapping = aes(x = day_of_week, y = intensity_by_weekday, fill = day_of_week)) + # nolint
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    labs(x = "day of the week", y = "intensity",
      title = "Average intensity per week of the day",
      caption = "Considering all 33 users")
```

```{r, class.source = 'fold-hide', message = FALSE}
hourly_intensities %>%
  group_by(time) %>%
  summarise(average_intensity = mean(total_intensity)) %>%
  ggplot() +
    geom_point(mapping = aes(x = time, y = average_intensity)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    scale_y_continuous(breaks = seq(0, 25, by = 2), limits = c(0, 25)) +
    labs(x = "hour of the day", y = "intensity",
      title = "Average intensity per hour of the day",
      caption = "Considering all 33 users")
```

**Conclusions**:   
* On average people tends to be slightly less active in the middle of the week  
* Visible minimum is on Sunday  
* Hourly intensity is similarly distributed to steps per hour  

```{r, class.source = 'fold-hide', message = FALSE}
daily_sleep_avg <- sleep_day %>%
  group_by(day_of_week) %>%
  summarise(sleep_by_weekday = mean(total_minutes_asleep))

  
daily_sleep_avg$day_of_week <- ordered(daily_sleep_avg$day_of_week, levels = # nolint
c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

daily_sleep_avg %>%
  ggplot() +
    geom_col(mapping = aes(x = day_of_week, y = sleep_by_weekday, fill = day_of_week)) + # nolint
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    labs(x = "day of the week", y = "minutes of sleep",
      title = "Average length of sleep per week of the day",
      caption = "Considering 24 sleep tracker users")
```

**Conclusions**:   
* On average people tends to sleep more during weekends  
* Sudden peak on Wednesdays, need more data to explain  
* Daily people spend `r round(mean(sleep_day$total_time_in_bed))` minutes in bed  
* Daily people spend `r round(mean(sleep_day$total_minutes_asleep))` minutes asleep  
* On average peaople sleep `r round(mean(sleep_day$total_sleep_records), 1)` times per day  

## Summary

**Found insights**:   
* User base start to decrease after 2 weeks  
* Half of users use it on daily basis  
* Most of the users use the device for either entire day or around 2/3 of a day  
* Average steps and intensity minimal on Sundays  
* Around 40% users use app only every 3 or more days 

**Recomendations**:   
* making a survey to understand why peaople are leaving after 2 weeks  
* sending out notifications on Sundays to remind people of staying active  
* finding ways to make product more attractive for people who use it rarely  
